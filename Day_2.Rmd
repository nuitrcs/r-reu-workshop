---
title: "Day 2"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(learnr)

tutorial_options(
  exercise.timelimit = 60,
  # A simple checker function that just returns the message in the check chunk
  exercise.checker = function(check_code, ...) {
    list(
      message = eval(parse(text = check_code)),
      correct = logical(0),
      type = "info",
      location = "append"
    )
  }
)
knitr::opts_chunk$set(error = TRUE)

r <- getOption("repos")
r["CRAN"] <- "https://cloud.r-project.org/"
options(repos = r)
```

## Let's recap Day 1

-   What are variables? Where can you see all the current variables in your workspace?

-   What are functions? Write out an example of a nested function.

```{r, recap, exercise=TRUE, exercise.eval = FALSE}
```

-   How would you set the working directory in RStudio? Set the working directory for today's session.

-   Write out the command to list all the files in your working directory

```{r, recap0, exercise=TRUE, exercise.eval = FALSE}
```

-   What is the difference between a Vector and a DataFrame?
-   Get the second element of the vector `x` below

```{r, recap1, exercise=TRUE, exercise.eval = FALSE}
x <- c(3,6,8,0,-1,4)
```

-   Get all elements of `x` greater than 2

```{r, recap2, exercise=TRUE, exercise.eval = FALSE}
```

-   Find the sum of all elements of `x`

```{r, recap3, exercise=TRUE, exercise.eval = FALSE}
```

-   Where can you look up the documentation for R functions? Find help on the function `write.csv`

-   Read in the file `ev_police_jan.csv` from the data folder

```{r, recap6, exercise=TRUE, exercise.eval = FALSE}
```

-   Install the `palmerpenguins` package and load it into the R workspace.

```{r, recap7, exercise=TRUE, exercise.eval = FALSE}
```

## Working with DataFrames

Today we will cover some of the basics of working with data frames. We're focused here on using the built-in, base R functions and features to work with data frames. It's good to understand these basics so that you can read R code that others write, and you can perform basic functions without other packages. However, in my daily work, I use the [tidyverse](https://github.com/nuitrcs/r-tidyverse) packages to work with data frames.

### Getting Data from a File

We learnt about importing data and loading it from packages. Most often, you will be reading in a data from a file like we learnt yesterday. As with other variables, when we type the name of the data frame, it will print the contents of the variable to the console.

### EXERCISE

Import and print the contents of the file `ev_police_jan.csv` from the data folder.

```{r}
```

Sometimes you might encounter an error. Below are some tips if you get an error message that a file can't be found when you're trying to import it:

1)  Check the spelling of the filename for typos

2)  Check your working directory (`getwd()`) and make sure the path to the file is correct and completely specified given what your working directory is.

3)  Make sure the file is actually in the folder you think it is. I recommend copying or moving any downloaded files into the project/directory for this workshop so you know you really have the file. I've seen some problems on Windows computers in particular before where a .zip file isn't really unzipped - it's just letting you see inside without actually expanding the contents and creating real files.

### Creating data frames manually

It's also possible to create a data frame from scratch. You will not do this often.

```{r, manualdf, exercise=TRUE, exercise.eval = FALSE}
x <- data.frame(month=month.name,
                index=1:12,
                days=c(31,28,31,30,31,30,31,31,30,31,30,31))
x
```

### From a Package

Let's explore the `penguins` dataset from <https://github.com/allisonhorst/palmerpenguins>. It's been included in an R package.

First, check that `penguins` is present in your workspace. Hint: use the `View()` function.

```{r, loaddata, exercise=TRUE, exercise.eval = FALSE}
penguins
```

## Data Shape and Names

What is `penguins`? `class()` tells us the type of the object -- what's stored in the variable.

```{r, loaddata2, exercise=TRUE, exercise.eval = FALSE}
class(penguins)
```

"tbl_df" is a tibble data frame. These behave a little bit differently from normal data frames. You'll see tibbles instead of data frames within the tidyverse set of packages (and those packages that work within that framework).

The biggest difference is that tibbles give you a tibble back when subsetting with [], while data frames sometimes give you a vector.

View the first few rows

```{r, d3, exercise=TRUE, exercise.eval = FALSE}
head(penguins)
```

Clicking on the name of the data frame in the environment tab will also open the viewer.

Dimensions of the data frame

```{r}
dim(penguins)
```

Rows is the first number, columns second.

What will the length of a data frame be?

```{r}
length(penguins)
```

\# of columns. This is because it's technically a list of vectors (lists are a different type). Don't use length with a data frame; use `ncol()` instead:

```{r}
ncol(penguins)
```

```{r}
nrow(penguins)
```

What are the variable names? The columns

```{r}
names(penguins)
colnames(penguins)
```

Rows have names too

```{r}
rownames(penguins)
```

These were generated by default. It's best to ignore row names. If there's unique information in the row names, make sure it gets put in an actual column in the data frame instead.

What are the column types?

```{r}
str(penguins)
```

Some variables are factors. These are categorical variables with a limited set of values. The different values are called levels.

If you read data in from a data frame, these would be read in as character data by default (AKA strings, text). Because this data frame was in a package, the columns had already been converted to factors.

Quick summary of every column

```{r}
summary(penguins)
```

## EXERCISE

Run the code that creates the `x` data frame.

Using the `x` data frame, write commands to figure out:

-   How many rows and columns?
-   Names of the variables?

```{r, d7, exercise=TRUE, exercise.eval = FALSE}
x <- data.frame(month=month.name,
                index=1:12,
                days=c(31,28,31,30,31,30,31,31,30,31,30,31))
```

## Indexing Basics

Indexing works like it does for vectors, but there are two dimensions: rows and columns. Rows come first, then columns.

Select first row

```{r, i1, exercise=TRUE, exercise.eval = FALSE}
penguins[1,]
```

Select first two rows

```{r, i2, exercise=TRUE, exercise.eval = FALSE}
penguins[1:2,]
```

Select first column

```{r, i3, exercise=TRUE, exercise.eval = FALSE}
penguins[,1]
```

This gave us a tibble/data.frame back, but with `x`:

```{r, i4, exercise=TRUE, exercise.eval = FALSE}
x[,1]
```

we get a vector back. This is one difference between tibbles and regular data frames.

We can select rows and columns at the same time:

```{r, i5, exercise=TRUE, exercise.eval = FALSE}
penguins[1:2, 4:5]
```

If we want rows or columns that aren't next to each other, you can use a vector.

```{r, i6, exercise=TRUE, exercise.eval = FALSE}
x[c(1, 3), ]
```

### EXERCISE

Using `x` created above: select rows 2 through 5, and columns 1 through 2 from `x`

```{r, i7, exercise=TRUE, exercise.eval = FALSE}
```

## Names

Each column in a dataframe is essentially a vector. You can reference columns by their names using the `$`notation. Note how R helpfully displays the column names in this dataframe as soon as you add the `$` operator.

Reference columns by name with `$` notation (no quotes on names)

```{r, n1, exercise=TRUE, exercise.eval = FALSE}
names(penguins)
```

```{r, n2, exercise=TRUE, exercise.eval = FALSE}
penguins$species
```

Note that the `$` notation got us a vector back.

```{r, n3, exercise=TRUE, exercise.eval = FALSE}
penguins$bill_length_mm
```

Use names in `[]`: put them in quotes like we learnt earlier

```{r, n4, exercise=TRUE, exercise.eval = FALSE}
penguins[,"species"]
```

Since we used `[]`, we get a tibble/data.frame back this time

```{r, n5, exercise=TRUE, exercise.eval = FALSE}
penguins[,"bill_length_mm"]
```

Multiple columns by name, need to use a vector of names:

```{r, n6, exercise=TRUE, exercise.eval = FALSE}
penguins[,c("island", "species")]
```

### EXERCISE

Using the `penguins` data frame:

-   Select the year column using `$` notation
-   Select the bill length and bill depth columns by name using `[]`

```{r, n7, exercise=TRUE, exercise.eval = FALSE}
```

## Boolean/Conditional Selection

If we have a boolean vector (`TRUE` and `FALSE` values) that is the same length as the number of rows or columns, we can use it to select from the data frame as we did with vectors.

```{r, b1, exercise=TRUE, exercise.eval = FALSE}
penguins$bill_length_mm < 34
```

Select the rows where bill length is less than 34:

```{r, b2, exercise=TRUE, exercise.eval = FALSE}
penguins[penguins$bill_length_mm < 34,]
```

Note the rows of `NA`.

Remember: the expression inside [] needs to be a complete expression. So we must use both the data frame name and the column name.

If we don't want the missing rows included:

```{r, b3, exercise=TRUE, exercise.eval = FALSE}
sum(is.na(penguins$bill_length_mm))  # how many missing?
penguins[is.na(penguins$bill_length_mm), ]  # which rows have missing values

# select rows where bill_length_mm is not missing and < 34
penguins[!is.na(penguins$bill_length_mm) & penguins$bill_length_mm < 34,]
```

If I forget the `,` in the `[]`:

```{r, b4, exercise=TRUE, exercise.eval = FALSE}
penguins[penguins$bill_length_mm < 34]
```

It tries to index the columns instead, and our vector is too long.

Multiple conditions

```{r, b5, exercise=TRUE, exercise.eval = FALSE}
penguins[penguins$bill_length_mm < 34 & penguins$bill_depth_mm < 16,]
```

```{r, b6, exercise=TRUE, exercise.eval = FALSE}
penguins[penguins$bill_length_mm < 34 | penguins$bill_length_mm > 58,]
```

### EXERCISE

Using `x` created above: select rows from `x` with 31 days. Use `==` for testing for equality.

```{r, b7, exercise=TRUE, exercise.eval = FALSE}

```

## Renaming Columns

Normally we don't need to do this first, but I want to keep the current names so I can reset the names later

```{r, rename1, exercise=TRUE, exercise.eval = FALSE}
oldnames <- names(penguins)  # save so we can reset later
```

Just like we use `names()` to get the names, use the same function to assign the names. This is different syntax than we see other places in R; `names()` is a special type of function called a replacement function.

I can change the name of the first variable with:

```{r, rename2, exercise=TRUE, exercise.eval = FALSE}
names(penguins)[1]
names(penguins)[1] <- "boo"  # change the name of the first column
names(penguins)
```

```{r, rename3, exercise=TRUE, exercise.eval = FALSE}
names(penguins) <- c("a", "b", "c", "d", "e", "f", "g", "h")  # change all of the column names
head(penguins)
```

Put the old names back

```{r, rename4, exercise=TRUE, exercise.eval = FALSE}
names(penguins) <- oldnames
head(penguins)  # check
```

## Working with Variables

We can work with individual columns as a vector by themselves:

```{r, var1, exercise=TRUE, exercise.eval = FALSE}
max(penguins$bill_length_mm)
```

```{r, var2, exercise=TRUE, exercise.eval = FALSE}
max(penguins$bill_length_mm, na.rm=TRUE)
```

Now to get the observations (rows) for the penguins with that max value:

```{r, var3, exercise=TRUE, exercise.eval = FALSE}
penguins[penguins$bill_length_mm == 59.6,]
```

But, we don't want to have to look up the value first, and then type it in. We can put the expression that got us that max value directly in the code:

```{r, var4, exercise=TRUE, exercise.eval = FALSE}
penguins[penguins$bill_length_mm == max(penguins$bill_length_mm, na.rm=TRUE),]
```

We could also break it out into steps and save the max value in a variable we can use:

```{r, var5, exercise=TRUE, exercise.eval = FALSE}
max_bill_length <- max(penguins$bill_length_mm, na.rm=TRUE)
penguins[penguins$bill_length_mm == max_bill_length,]
```

Why? What if something in the data changes? Then we'd have the wrong value written in (hard coded) into our code. We want to avoid "hard coding" specific values that are derived from data into our scripts where we can.

### EXERCISE

Using `x` created above (data frame of months): select the rows from `x` where `days` is at its minimum value.

```{r, var6, exercise=TRUE, exercise.eval = FALSE}

```

You can also use `which.min()` or `which.max()` to get the index location of the first value with the minimum or maximum value respectively (if there's more than one you only get one):

```{r, var7, exercise=TRUE, exercise.eval = FALSE}
x[which.min(x$days), ]
```

## Making new variables

We can add a new variable to the data frame by naming it with the `$` notation, and assigning a value to it. For example, make a variable that has bill length in **centimeters (cm)** instead of **millimeters (mm)**

```{r}
penguins$bill_length_cm <- penguins$bill_length_mm / 10  # make new variable: note CM instead of MM in the name
names(penguins)  # check to see that it was added
penguins[, c("bill_length_cm", "bill_length_mm")]  # select the two vars to view them
```

### EXERCISE

Make a variable that has bill length in **centimeters (cm)** instead of **millimeters (mm)**

```{r, var8, exercise=TRUE, exercise.eval = FALSE}
```

Using `x` created above: make a new variable as part of `x`, called `weeks`, that is the number of days divided by 7.

```{r, var9, exercise=TRUE, exercise.eval = FALSE}
```

## Missing values

Remember: `NA` denotes a missing value.

Any missing values? They will show up in summary() output:

```{r, missing1, exercise=TRUE, exercise.eval = FALSE}
summary(penguins)
```

Look at the rows where `body_mass_g` is missing:

```{r, missing2, exercise=TRUE, exercise.eval = FALSE}
is.na(penguins$body_mass_g)
penguins[is.na(penguins$body_mass_g),]
```

Remove rows where `body_mass_g` is missing by selecting rows where the value is not missing:

```{r, missing3, exercise=TRUE, exercise.eval = FALSE}
penguins[!is.na(penguins$body_mass_g),]
penguins <- penguins[!is.na(penguins$body_mass_g),]
```

The function `complete.cases()` can be used to find which rows have no missing values at all:

### EXERCISE

Run the code to create a y data frame. Then remove the rows where the height variable has a missing value.

```{r, missing4, exercise=TRUE, exercise.eval = FALSE}
y <- data.frame(age = c(40, 38, 44, 41, 68, 6, 35, 29),
                height = c(NA, 65, 68, 70, 63, 50, NA, 73))
```

## Replacing Values

```{r, replace1, exercise=TRUE, exercise.eval = FALSE}
table(penguins$species)
```

`species` is a factor (a special type for categorical variables); let's un-factor it first so we can change values -- this is an extra step related to it being a factor. We'll convert it to be data of type character, which is just free text.

```{r, replace2, exercise=TRUE, exercise.eval = FALSE}
penguins$species <- as.character(penguins$species)
```

Here are the general steps we'd do if we didn't have a factor

```{r, replace3, exercise=TRUE, exercise.eval = FALSE}
penguins$species[penguins$species == "Gentoo"]  # which observations do we want to replace?

penguins$species[penguins$species == "Gentoo"] <- "gentoo"  # set the value

table(penguins$species)
```

### EXERCISE

Using `x` created above: replace the `month` value "December" with the value "Dec" instead

```{r, replace4, exercise=TRUE, exercise.eval = FALSE}

```

## Data Frames Practice

Here are some practice exercises for working with data frames. They all use the policing data here:

```{r, ex, exercise=TRUE, exercise.eval = FALSE}
evp <- read.csv("data/ev_police_jan.csv")
```

If you mess up the data frame, you can always read it back in from the file.

### EXERCISE 1

What are the variable names, and how many observations are there?

```{r, ex1, exercise=TRUE, exercise.eval = FALSE}

```

### EXERCISE 2

Are there any missing values in the data?

```{r, ex2, exercise=TRUE, exercise.eval = FALSE}

```

### EXERCISE 3

What is the most common location? You may want to use the `table()` function.

Hint: you can use the `sort()` function in combination with the `table()` function: `sort(table(x))`

```{r, ex3, exercise=TRUE, exercise.eval = FALSE}

```

### EXERCISE 4

How many stops found contraband?

Hint (for one approach to this): if you `sum()` a boolean variable, TRUE = 1, FALSE = 0, so it counts the TRUE values. Remember to deal with missing values with `sum()`: `sum(x, na.rm=TRUE)`

```{r, ex4, exercise=TRUE, exercise.eval = FALSE}

```

### EXERCISE 5

Rename the column "raw_row_number" to "id"

```{r, ex5, exercise=TRUE, exercise.eval = FALSE}

```

### EXERCISE 6

Subset the data frame to just have rows where subject_sex is "female".

```{r, ex6, exercise=TRUE, exercise.eval = FALSE}

```

### EXERCISE 7

Make a new column in the data frame called evanston that is TRUE if the location is 60201 or 60202 and FALSE otherwise.

```{r, ex7, exercise=TRUE, exercise.eval = FALSE}

```

### EXERCISE 8

This exercise is more challenging than the others.

What is the *make* of the oldest vehicles in the data set.

Hint: there are two observations in the data that both have the minimum vehicle_year.

```{r, ex8, exercise=TRUE, exercise.eval = FALSE}

```

### EXERCISE 9

This exercise is more challenging than the others.

What percentage of men in the dataset drive a Toyota ("TOYT")? How does this compare to the percentage of women who drive a Toyota?

What percentage of Toyota drivers are male? What percentage of drivers in the data set are male?

```{r, ex9, exercise=TRUE, exercise.eval = FALSE}

```

## Data Visualization 

Often, plotting your data will be much more informative than summary statistics alone. R has built-in plotting functions, as well as several packages such as *ggplot* which offer advanced plotting capabilities.

### Points

The `plot()` function is used to draw points (markers) in a diagram. The The function takes parameters for specifying points in the diagram. Parameter 1 specifies points on the **x-axis**. Parameter 2 specifies points on the **y-axis**. Let's see a simple example below.

```{r}
plot(1, 3)
```

To draw more points, use vectors.

```{r}
x <- c(1, 2, 3, 4, 5)
y <- c(3, 7, 8, 9, 12)
plot(x, y) 
```

Remember that data frame columns are also vectors!

```{r}
plot(penguins$bill_length_mm, penguins$bill_depth_mm)
```

### Lines

The `plot()` function also takes a `type` parameter with the value `l` to draw a line to connect all the points in your plot

```{r}
plot(x, y, type='l') 
```

### Plot labels

The `plot()` function also accept other parameters, such as `main`, `xlab` and `ylab` if you want to customize the graph with a main title and different labels for the x and y-axis.

```{r}
plot(x, y, main="My Amazing Graph", xlab="The x-axis", ylab="The y-axis")
```

### Graph Appearance

There are many other parameters you can use to change the appearance of the points.

Use `col="color"` to add color to the points.

```{r}
plot(x,y, col="red")
```

Use `cex=number` to change the size of the points (1 is default, while 0.5 means 50% smaller, and 2 means 100% larger)

```{r}
plot(x,y, cex=2)
```

Use `pch` with a value from 0 to 25 to change the point shape format.

```{r}
plot(x,y, pch=25, cex=2)
```

The values of the `pch` parameter ranges from 0 to 25, which means that we can choose up to 26 different types of point shapes

![](https://www.w3schools.com/r/r_plot_pch2.png){width="208"}

### EXERCISE

Using the penguins data, plot body mass on y-axis vs flipper length on x-axis for the Chinstrap species. Choose the filled circle marker type and color the markers purple. Set marker size to 0.5, and label the axes and title the graph "Body mass vs Flipper length in Chinstrap penguins".

```{r}

```

What can you say about the relationship between body mass and flipper size in this species?

## Advanced data viz with *ggplot2*

The R package *ggplot2* is the most widely used and aesthetically pleasing graphics framework available in R. It relies on a structure called the "grammar of graphics". Essentially, it follows a layered approach to describe and construct the visualization.

First, install and load the *ggplot2* package in your workspace.

```{r}
install.packages("ggplot2")
library(ggplot2)
```

![](https://miro.medium.com/v2/resize:fit:2000/format:webp/1*mcLnnVdHNg-ikDbHJfHDNA.png){width="646"}

Typically, to build or describe any visualization with one or more dimensions, we can use the components as follows.

1.  **Data**: Always start with the data, identify the dimensions you want to visualize.

2.  **Aesthetics**: Confirm the axes based on the data dimensions, positions of various data points in the plot. Also check if any form of encoding is needed including size, shape, color and so on which are useful for plotting multiple data dimensions.

3.  **Scale:** Do we need to scale the potential values, use a specific scale to represent multiple values or a range? For example you can scale the data to log of the original values.

4.  **Geometric objects:** These are popularly known as \'geoms\'. This would cover the way we would depict the data points on the visualization. Should it be points, bars, lines and so on?

5.  **Statistics:** Do we need to show some statistical measures in the visualization like measures of central tendency, spread, confidence intervals?

6.  **Facets:** Do we need to create subplots based on specific data dimensions?

7.  **Coordinate system:** What kind of a coordinate system should the visualization be based on ---should it be cartesian or polar?

Here is a handy [cheat sheet for ggplot2](https://statsandr.com/blog/files/ggplot2-cheatsheet.pdf)!

### Grammar of Graphics in Action!

**Data**: We will be using the `penguins` dataset

**Aesthetics**: The x-axis will be flipper length, and the y-axis will be body mass

**Geometric objects**: We choose a dot to represent each data point

```{r}
ggplot(data=penguins, aes(x = flipper_length_mm, y = body_mass_g)) + geom_point()
```

Notice how layering works with the + operator.

Change the colors and transparency of the points by setting parameters within `geom_points`

```{r}
ggplot(data=penguins, aes(x = flipper_length_mm, y = body_mass_g)) + 
  geom_point(alpha=0.5)
```

```{r}
ggplot(data=penguins, aes(x = flipper_length_mm, y = body_mass_g)) + 
  geom_point(alpha=0.5, color="red")
```

You can also pass these parameters to `aes` and they will be automatically passed on to any geometric objects. Look up R help for `aes` and remember we talked about `…` yesterday in function inputs.

```{r}
ggplot(data=penguins, aes(x = flipper_length_mm, y = body_mass_g, alpha=0.5, color="red")) + 
  geom_point()
```

Now suppose, we want to make the graph more elegant. Let's use themes to clean up the background.

```{r}
ggplot(data=penguins, aes(x = flipper_length_mm, y = body_mass_g, alpha=0.5, color="red")) + 
  geom_point() +
  theme_classic() 
```

Add labels to the axes

```{r}
ggplot(data=penguins, aes(x = flipper_length_mm, y = body_mass_g, alpha=0.5, color="red")) + 
  geom_point() +
  theme_classic() +
  labs(x = "Flipper length (mm)", y = "Body mass (g)", title = "Penguins Data")
```

However, this data is not very informative! We've mixed up all the species together. Let's try to color each point based on the species it belongs to. We can do this by setting the color in `aes` by the column species.

But first let's see how setting aesthetics using `aes` works.

```{r}
ggplot(data=penguins, aes(x = flipper_length_mm, y = body_mass_g, color=species)) +
  geom_point() +
  theme_classic() +
  labs(x = "Flipper length (mm)", y = "Body mass (g)", title = "Penguins Data")
```

You can also do this by setting `group` in `aes` , and setting the aesthetics for `geom_point` separately. This is useful if you want to plot multiple geoms in a plot (eg scatter points and a regression line).

```{r}
ggplot(data=penguins, aes(x = flipper_length_mm, y = body_mass_g, group=species)) +
  geom_point(aes(color = species)) +
  theme_classic() +
  labs(x = "Flipper length (mm)", y = "Body mass (g)", title = "Penguins Data")
```

Let's add some more properties to `geom_point`

```{r}
ggplot(data=penguins, aes(x = flipper_length_mm, y = body_mass_g, group=species)) +
  geom_point(aes(color = species, 
                 shape = species),
             size = 2,
             alpha = 0.8) +
  theme_classic() +
  labs(x = "Flipper length (mm)", y = "Body mass (g)", title = "Penguins Data")
```

### EXERCISE

View the `mtcars` dataset (it is already included with R). Plot the weight `wt` on x and the miles per gallon `mpg` on y. What is the relationship between the two variables?

```{r}

```

Choose a theme from the [cheat sheet](https://statsandr.com/blog/files/ggplot2-cheatsheet.pdf) and add it to the plot, along with axis and main titles

```{r}

```

Color the points by gear

```{r}

```

What do you notice about the geom point color that is different from the penguins plot we looked at earlier?
